((('apd () (exp ys)) ys)
 (('apd ((exp x) exp xs) (exp ys)) `(,x unquote (& (apd ,xs ,ys))))
 (('pair () ()) ())
 (('pair ((exp x) exp xs) ((exp y) exp ys))
  `((,x unquote y) unquote (& (pair ,xs ,ys))))
 (('lookup (sym k) (((sym k) exp v) . _)) v)
 (('lookup (sym k) ((_ . _) exp env)) (& (lookup ,k ,env)))
 (('updated (sym k) (exp v) (((sym k) . _) exp env))
  `((,k unquote v) unquote env))
 (('updated (sym k) (exp v) ((exp kv) exp env))
  `(,kv unquote (& (updated ,k ,v ,env))))
 (('updated (sym k) (exp v) ()) `((,k unquote v)))
 (('eval () _) ())
 (('eval (num n) _) n)
 (('eval (sym s) (exp env)) (& (lookup ,s ,env)))
 (('eval ('quote (exp e)) _) e)
 (('eval ('if (exp p) (exp c) (exp a)) (exp env))
  (& (ev-if ,(& (eval ,p ,env)) ,c ,a ,env)))
 (('eval ('lambda (exp vs) (exp e)) (exp env)) `(lambda ,vs ,e))
 (('eval (exp ap) (exp env)) (& (apply ,(& (evlis ,ap ,env)) ,env)))
 (('ev-if () _ (exp a) (exp env)) (& (eval ,a ,env)))
 (('ev-if _ (exp c) _ (exp env)) (& (eval ,c ,env)))
 (('evlis () (exp env)) ())
 (('evlis ((exp e) exp es) (exp env))
  `(,(& (eval ,e ,env)) unquote (& (evlis ,es ,env))))
 (('apply ('cons (exp h) (exp t)) _) `(,h unquote t))
 (('apply ('car ((exp h) . _)) _) h)
 (('apply ('cdr (_ exp t)) _) t)
 (('apply ('eq? (exp x) (exp x)) _) T)
 (('apply ('eq? _ _) _) ())
 (('apply ('num? (num n)) _) T)
 (('apply ('num? _) _) ())
 (('apply ('sym? (sym s)) _) T)
 (('apply ('sym? _) _) ())
 (('apply ('atm? (atm a)) _) T)
 (('apply ('atm? _) _) ())
 (('apply ('+ (num n) (num m)) _) (+ n m))
 (('apply ('- (num n) (num m)) _) (- n m))
 (('apply ('* (num n) (num m)) _) (* n m))
 (('apply (('lambda (exp vs) (exp e)) exp as) (exp env))
  (& (eval ,e ,(& (apd ,(& (pair ,vs ,as)) ,env)))))
 (('init-env (exp self-evs)) (& (pair ,self-evs ,self-evs)))
 (('run (exp program))
  (& (run ,program ,(& (init-env (T cons car cdr + - * eq? num? sym? atm?))))))
 (('run () _) 'the-end?!)
 (('run (('def (sym s) (exp e)) exp prg) (exp top))
  (& (run ,prg ,(& (updated ,s ,(& (eval ,e ,top)) ,top)))))
 (('run ((exp form)) (exp top)) (& (eval ,form ,top)))
 (('example)
  (& (run ((def sq (lambda (n) (* n n)))
           (def ! (lambda (n) (if (eq? n 0) 1 (* n (! (- n 1))))))
           (! (sq 2)))))))
