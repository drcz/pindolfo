((('apd () (exp ys)) ys)
 (('apd ((exp x) exp xs) (exp ys)) `(,x unquote (rec (apd ,xs ,ys))))
 (('pair () ()) ())
 (('pair ((exp x) exp xs) ((exp y) exp ys))
  `((,x unquote y) unquote (rec (pair ,xs ,ys))))
 (('lookup (sym k) (((sym k) exp v) . _)) v)
 (('lookup (sym k) ((_ . _) exp env)) (rec (lookup ,k ,env)))
 (('updated (sym k) (exp v) (((sym k) . _) exp env))
  `((,k unquote v) unquote env))
 (('updated (sym k) (exp v) ((exp kv) exp env))
  `(,kv unquote (rec (updated ,k ,v ,env))))
 (('updated (sym k) (exp v) ()) `((,k unquote v)))
 (('eval () _) ())
 (('eval (num n) _) n)
 (('eval (sym s) (exp env)) (rec (lookup ,s ,env)))
 (('eval ('quote (exp e)) _) e)
 (('eval ('if (exp p) (exp c) (exp a)) (exp env))
  (rec (ev-if ,(rec (eval ,p ,env)) ,c ,a ,env)))
 (('eval ('lambda (exp vs) (exp e)) (exp env)) `(lambda ,vs ,e))
 (('eval (exp ap) (exp env)) (rec (apply ,(rec (evlis ,ap ,env)) ,env)))
 (('ev-if () _ (exp a) (exp env)) (rec (eval ,a ,env)))
 (('ev-if _ (exp c) _ (exp env)) (rec (eval ,c ,env)))
 (('evlis () (exp env)) ())
 (('evlis ((exp e) exp es) (exp env))
  `(,(rec (eval ,e ,env)) unquote (rec (evlis ,es ,env))))
 (('apply ('cons (exp h) (exp t)) _) `(,h unquote t))
 (('apply ('car ((exp h) . _)) _) h)
 (('apply ('cdr (_ exp t)) _) t)
 (('apply ('eq? (exp x) (exp x)) _) T)
 (('apply ('eq? _ _) _) ())
 (('apply ('num? (num n)) _) T)
 (('apply ('num? _) _) ())
 (('apply ('sym? (sym s)) _) T)
 (('apply ('sym? _) _) ())
 (('apply ('atm? (atm a)) _) T)
 (('apply ('atm? _) _) ())
 (('apply ('+ (num n) (num m)) _) (+ n m))
 (('apply ('- (num n) (num m)) _) (- n m))
 (('apply ('* (num n) (num m)) _) (* n m))
 (('apply (('lambda (exp vs) (exp e)) exp as) (exp env))
  (rec (eval ,e ,(rec (apd ,(rec (pair ,vs ,as)) ,env)))))
 (('init-env (exp self-evs)) (rec (pair ,self-evs ,self-evs)))
 (('run (exp program))
  (rec (run ,program ,(rec (init-env (T cons car cdr + - * eq? num? sym? atm?))))))
 (('run () _) 'the-end?!)
 (('run (('def (sym s) (exp e)) exp prg) (exp top))
  (rec (run ,prg ,(rec (updated ,s ,(rec (eval ,e ,top)) ,top)))))
 (('run ((exp form)) (exp top)) (rec (eval ,form ,top)))
 (('example)
  (rec (run ((def sq (lambda (n) (* n n)))
           (def ! (lambda (n) (if (eq? n 0) 1 (* n (! (- n 1))))))
           (! (sq 2)))))))
