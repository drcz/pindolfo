(
 ;(---------------------------------------------------------------------)
 ;(- tmp rewriter from scm compilate to pindolfina bytecode            -)

 (('apd () ?ys) => ys)
 (('apd (?x . ?xs) ?ys) => `(,x . ,^(apd ,xs ,ys)))

 (('map _   ()        ) => ())
 (('map ?op (?x . ?xs)) => `(,^(,op ,x) . ,^(map ,op ,xs)))

 (('map-apd _   ()        ) => ())
 (('map-apd ?op (?x . ?xs)) => ^(apd ,^(,op ,x) ,^(map-apd ,op ,xs)))

 (('rev ?xs) => ^(rev* ,xs ()))
 (('rev* ()         ?rs) => rs)
 (('rev* (?x . ?xs) ?rs) => ^(rev* ,xs (,x . ,rs)))

 (('len ()) => 0)
 (('len (_ . ?xs)) => (+ 1 ^(len ,xs)))

 ;(---------------------------------------------------------------------)

 (('addr-for $var 'in ($var . _)) => `(A))
 (('addr-for $var 'in (_ . ?xs)) => `(D . ,^(addr-for ,var in ,xs)))

 ;(---------------------------------------------------------------------)

 (('code-for ('define ($id . ?arglst) ('if . ?stuff))) => `(,id (,^(c-leaf (if . ,stuff) ,arglst))))
 (('code-for ('define ($id . ?arglst) ?body)) => `(,id ,^(c-leaf ,body ,arglst)))
 (('compiled ?program) => ^(map code-for ,program))

 (('c-leaf ('if ?t ?b ?b*) ?d) => ^((c-if ,d) (if ,t ,b ,b*)))
 (('c-leaf ('let* ?as ?e)  ?d) => ^((c-let ,d) ,as ,e))
 (('c-leaf ?e              ?d) => ^((c-exp ,d) ,e))

 ((('c-exp ?d) ('quote ())) => `((CONST ())))
 ((('c-exp ?d) ('quote $e)) => `((CONST ,e)))
 ((('c-exp ?d) #n) => `((CONST ,n)))
 ((('c-exp ?d) $var) => `((LD ,^(addr-for ,var in ,d))))
 ((('c-exp ?d) ('+ ?e ?e*)) => ^(apd ,^((c-exp ,d) ,e*) ,^(apd ,^((c-exp ,d) ,e) ((ADD)))))
 ((('c-exp ?d) ('- ?e ?e*)) => ^(apd ,^((c-exp ,d) ,e*) ,^(apd ,^((c-exp ,d) ,e) ((SUB)))))
 ((('c-exp ?d) ('* ?e ?e*)) => ^(apd ,^((c-exp ,d) ,e*) ,^(apd ,^((c-exp ,d) ,e) ((MUL)))))
 ((('c-exp ?d) ('modulo ?e ?e*)) => ^(apd ,^((c-exp ,d) ,e*) ,^(apd ,^((c-exp ,d) ,e) ((MOD)))))
 ((('c-exp ?d) ('quotient ?e ?e*)) => ^(apd ,^((c-exp ,d) ,e*) ,^(apd ,^((c-exp ,d) ,e) ((DIV)))))
 ((('c-exp ?d) (('lambda ('n 'm) ('if ('< 'n 'm) ('quote 'YES) ('quote 'NO))) ?e ?e*))
  => ^(apd ,^((c-exp ,d) ,e*) ,^(apd ,^((c-exp ,d) ,e) ((LT)))))
 ((('c-exp ?d) ('cons ?e ?e*)) => ^(apd ,^((c-exp ,d) ,e*) ,^(apd ,^((c-exp ,d) ,e) ((CONS)))))
 ((('c-exp ?d) ('car ?e)) => ^(apd ,^((c-exp ,d) ,e) ((CAR))))
 ((('c-exp ?d) ('cdr ?e)) => ^(apd ,^((c-exp ,d) ,e) ((CDR))))
 ((('c-exp ?d) ('FAIL ?a)) => ^(apd ,^((c-exp ,d) ,a) ((FAIL))))
 ((('c-exp ?d) ($cid . ?as)) => ^(apd ,^(map-apd (c-exp ,d) ,^(rev ,as)) ((CALL ,cid ,^(len ,as)))))

 ((('c-let ?d) () ?fe) => ^((c-exp ,d) ,fe))
 ((('c-let ?d) (($v ?e) . ?as) ?e*) => ce <- ^((c-exp ,d) ,e)
                                       ^(apd ,ce ,^(apd ((ST)) ,^((c-let (,v . ,d)) ,as ,e*))))

 ((('c-if ?d) ('if ?t ?b ?b*)) => `(IF ,^((c-test ,d) ,t) ,^(c-leaf ,b ,d) ,^(c-leaf ,b* ,d)))

 ;(- sorry for the following -- these are likely teporary measures, and btw -)
 ;(- btw this entire script is temporary so why am i even writing this?     -)
 ((('c-test ?d) ('equal? #n ('+ ?e0 ?e1)) ) => ^(mk-<calc> ,n (+ ,e0 ,e1) ,d))
 ((('c-test ?d) ('equal? $v ('+ ?e0 ?e1)) ) => ^(mk-<calc> ,v (+ ,e0 ,e1) ,d))
 ((('c-test ?d) ('equal? #n ('- ?e0 ?e1)) ) => ^(mk-<calc> ,n (- ,e0 ,e1) ,d))
 ((('c-test ?d) ('equal? $v ('- ?e0 ?e1)) ) => ^(mk-<calc> ,v (- ,e0 ,e1) ,d))
 ((('c-test ?d) ('equal? #n ('* ?e0 ?e1)) ) => ^(mk-<calc> ,n (* ,e0 ,e1) ,d))
 ((('c-test ?d) ('equal? $v ('* ?e0 ?e1)) ) => ^(mk-<calc> ,v (* ,e0 ,e1) ,d))
 ((('c-test ?d) ('equal? #n ('/ ?e0 ?e1)) ) => ^(mk-<calc> ,n (/ ,e0 ,e1) ,d))
 ((('c-test ?d) ('equal? $v ('/ ?e0 ?e1)) ) => ^(mk-<calc> ,v (/ ,e0 ,e1) ,d))
 ((('c-test ?d) ('equal? #n ('% ?e0 ?e1)) ) => ^(mk-<calc> ,n (% ,e0 ,e1) ,d))
 ((('c-test ?d) ('equal? $v ('% ?e0 ?e1)) ) => ^(mk-<calc> ,v (% ,e0 ,e1) ,d))
 ;(- in the unlikely case of complex LHS or reversed args, <calc> works too -)
 (('mk-<calc> ?e0 ?e1 ?d) => e0* <- ^(mk-<calc> ,e0 ,d)
                             e1* <- ^(mk-<calc> ,e1 ,d)
                             `(<calc> (EQ? ,e0* ,e1*)))
  (('mk-<calc> #n ?d) => n)
  (('mk-<calc> $v ?d) => ^(addr-for ,v in ,d))
  (('mk-<calc> ('+ ?e0 ?e1) ?d) => e0* <- ^(mk-<calc> ,e0 ,d)
                                   e1* <- ^(mk-<calc> ,e1 ,d)
                                  `(+ ,e0* ,e1*))
  (('mk-<calc> ('- ?e0 ?e1) ?d) => e0* <- ^(mk-<calc> ,e0 ,d)
                                   e1* <- ^(mk-<calc> ,e1 ,d)
                                  `(- ,e0* ,e1*))
  (('mk-<calc> ('* ?e0 ?e1) ?d) => e0* <- ^(mk-<calc> ,e0 ,d)
                                   e1* <- ^(mk-<calc> ,e1 ,d)
                                  `(* ,e0* ,e1*))
  (('mk-<calc> ('/ ?e0 ?e1) ?d) => e0* <- ^(mk-<calc> ,e0 ,d)
                                   e1* <- ^(mk-<calc> ,e1 ,d)
                                  `(/ ,e0* ,e1*))
  (('mk-<calc> ('% ?e0 ?e1) ?d) => e0* <- ^(mk-<calc> ,e0 ,d)
                                   e1* <- ^(mk-<calc> ,e1 ,d)
                                  `(% ,e0* ,e1*))
  (('mk-<calc> ?a ?d) => ^(mk-addr ,a ,d))
 ;(--------------------------------------------------------------------------)

 ((('c-test ?d) ('null? ?a)       ) => `(NIL? ,^(mk-addr ,a ,d)))
 ((('c-test ?d) ('pair? ?a)       ) => `(CONS? ,^(mk-addr ,a ,d)))
 ((('c-test ?d) ('not ('pair? ?a))) => `(ATM? ,^(mk-addr ,a ,d)))
 ((('c-test ?d) ('number? ?a)     ) => `(NUM? ,^(mk-addr ,a ,d)))
 ((('c-test ?d) ('symbol? ?a)     ) => `(SYM? ,^(mk-addr ,a ,d)))
 ((('c-test ?d) ('equal? () ?a)           ) => `(NIL? ,^(mk-addr ,a ,d)))
 ((('c-test ?d) ('equal? #n ?a)           ) => `(EQ? ,n ,^(mk-addr ,a ,d)))
 ((('c-test ?d) ('equal? ('quote ?e) ?a)  ) => `(EQ? (quote ,e) ,^(mk-addr ,a ,d)))
 ((('c-test ?d) ('equal? ('cons ?h ?t) ?a)) => ^(mk-complex-test (cons ,h ,t) ,a ,d))
 ((('c-test ?d) ('equal? ?a ?a*)          ) => `(EQ? ,^(mk-addr2 ,a ,d) ,^(mk-addr ,a* ,d)))

 (('mk-addr $var ?d) => ^(addr-for ,var in ,d))
 (('mk-addr ('car ?a) ?d) => ^(apd ,^(mk-addr ,a ,d) (A)))
 (('mk-addr ('cdr ?a) ?d) => ^(apd ,^(mk-addr ,a ,d) (D)))

 (('mk-addr2 $var ?d) => ^(addr-for ,var in ,d))
 (('mk-addr2 ('car ?a) ?d) => ^(apd ,^(mk-addr2 ,a ,d) (A)))
 (('mk-addr2 ('cdr ?a) ?d) => ^(apd ,^(mk-addr2 ,a ,d) (D)))
 
(('mk-complex-test ()            ?a ?d) => `(NIL? ,^(mk-addr ,a ,d)))
(('mk-complex-test #n            ?a ?d) => `(EQ? ,n ,^(mk-addr ,a ,d)))
(('mk-complex-test ('quote ?e)   ?a ?d) => `(EQ? ,e ,^(mk-addr ,a ,d)))
(('mk-complex-test $var          ?a ?d) => `(EQ? ,^(mk-addr ,var ,d) ,^(mk-addr ,a ,d)))
(('mk-complex-test ('cons ?h ?t) ?a ?d) => `(and (CONS? ,^(mk-addr ,a ,d))
                                                 (and ,^(mk-complex-test ,h (car ,a) ,d)
                                                      ,^(mk-complex-test ,t (cdr ,a) ,d))))
)
