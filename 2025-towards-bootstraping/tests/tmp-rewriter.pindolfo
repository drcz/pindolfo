(
 ;(---------------------------------------------------------------------)
 ;(- tmp rewriter from scm compilate to pindolfina bytecode            -)

 (('apd () ?ys) => ys)
 (('apd (?x . ?xs) ?ys) => `(,x . ,^(apd ,xs ,ys)))

 (('map _   ()        ) => ())
 (('map ?op (?x . ?xs)) => `(,^(,op ,x) . ,^(map ,op ,xs)))

 (('map-apd _   ()        ) => ())
 (('map-apd ?op (?x . ?xs)) => ^(apd ,^(,op ,x) ,^(map-apd ,op ,xs)))

 (('rev ?xs) => ^(rev* ,xs ()))
 (('rev* ()         ?rs) => rs)
 (('rev* (?x . ?xs) ?rs) => ^(rev* ,xs (,x . ,rs)))

 (('len ()) => 0)
 (('len (_ . ?xs)) => (+ 1 ^(len ,xs)))

 ;(---------------------------------------------------------------------)

 (('addr-for $var 'in ($var . _)) => `(A))
 (('addr-for $var 'in (_ . ?xs)) => `(D . ,^(addr-for ,var in ,xs)))

 ;(---------------------------------------------------------------------)

 (('c-leaf ('if ?t ?b ?b*) ?d) => ^((c-if ,d) (if ,t ,b ,b*)))
 (('c-leaf ('let* ?as ?e)  ?d) => ^((c-let ,d) ,as ,e))
 (('c-leaf ?e              ?d) => ^((c-exp ,d) ,e))

 ((('c-exp ?d) ('quote ())) => `((CONST ())))
 ((('c-exp ?d) ('quote $e)) => `((CONST ,e)))
 ((('c-exp ?d) #n) => `((CONST ,n)))
 ((('c-exp ?d) $var) => `((LD ,^(addr-for ,var in ,d))))
 ((('c-exp ?d) ('+ ?e ?e*)) => ^(apd ,^((c-exp ,d) ,e*) ,^(apd ,^((c-exp ,d) ,e) ((ADD)))))
 ((('c-exp ?d) ('- ?e ?e*)) => ^(apd ,^((c-exp ,d) ,e*) ,^(apd ,^((c-exp ,d) ,e) ((SUB)))))
 ((('c-exp ?d) ('* ?e ?e*)) => ^(apd ,^((c-exp ,d) ,e*) ,^(apd ,^((c-exp ,d) ,e) ((MUL)))))
 ((('c-exp ?d) ('modulo ?e ?e*)) => ^(apd ,^((c-exp ,d) ,e*) ,^(apd ,^((c-exp ,d) ,e) ((MOD)))))
 ((('c-exp ?d) ('quotient ?e ?e*)) => ^(apd ,^((c-exp ,d) ,e*) ,^(apd ,^((c-exp ,d) ,e) ((DIV)))))
 ((('c-exp ?d) (('lambda ('n 'm) ('if ('< 'n 'm) ('quote 'YES) ('quote 'NO))) ?e ?e*))
  => ^(apd ,^((c-exp ,d) ,e*) ,^(apd ,^((c-exp ,d) ,e) ((LT)))))
 ((('c-exp ?d) ('cons ?e ?e*)) => ^(apd ,^((c-exp ,d) ,e*) ,^(apd ,^((c-exp ,d) ,e) ((CONS)))))
 ((('c-exp ?d) ('car ?e)) => ^(apd ,^((c-exp ,d) ,e) ((CAR))))
 ((('c-exp ?d) ('cdr ?e)) => ^(apd ,^((c-exp ,d) ,e) ((CDR))))
 ((('c-exp ?d) ($cid . ?as)) => ^(apd ,^(map-apd (c-exp ,d) ,^(rev ,as)) ((CALL ,cid ,^(len ,as)))))

 ((('c-let ?d) () ?fe) => ^(apd ,^((c-exp ,d) ,fe) ((RET))))
 ((('c-let ?d) (($v ?e) . ?as) ?e*) => ce <- ^((c-exp ,d) ,e)
                                       d* <- `(,v . ,d)
                                       ^(apd ,ce ,^(apd ((ST)) ,^((c-let ,d*) ,as ,e*))))

 ((('c-if ?d) ('if ?t ?b ?b*)) => 'TODO)

 ((('c-test ?d) ('null? ?a)) `(NIL? ,^(mk-addr ,a ,d)))
 ((('c-test ?d) ('pair? ?a)) `(CONS? ,^(mk-addr ,a ,d)))
 ((('c-test ?d) ('number? ?a)) `(NUM? ,^(mk-addr ,a ,d)))

 (('mk-addr $var ?d) => ^(addr-for ,var in ,d))
 (('mk-addr ('car ?a) ?d) => ^(apd ,^(mk-addr ,a ,d) (A)))
 (('mk-addr ('cdr ?a) ?d) => ^(apd ,^(mk-addr ,a ,d) (D)))
 
)
